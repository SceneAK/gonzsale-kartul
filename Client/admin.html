<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlls</title>
    <style>
        body{
            background-color: whitesmoke;
        }
        .bool{
            color: lightseagreen;
        }
        .number{
            color: green
        }
        .string{
            color: lightcoral;
        }
        .null{
            color: darkslategray;
        }
        .undefined{
            color: darkorange
        }
        strong, p{
            display: inline;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="queryDiv">
        <strong>RAW HTTP REQUESTS</strong>
        <br>
        Endpoint: <input type="text" id="endpointInput" value="/">
        Method: <select id="methodSelect">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PATCH">PATCH</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
        </select>
        Credentials: <select id="credentialSelect">
            <option value="omit">omit</option>
            <option value="include">include</option>
        </select>
        <textarea id="jsonBodyTextArea" placeholder="request body..."></textarea>
        <button onclick="sendJSON()">Send Application/JSON</button>
        <textarea id="errorP" readonly></textarea>
    </div>
    <div id="resultDiv"></div>
</body>
<script type="module" defer>
    import {fetching, user} from './integration/fetches.js';
    const resultDiv = document.getElementById('resultDiv');
    const queryDiv = document.getElementById('queryDiv');
    const errorP = document.getElementById('errorP');
    const endpointInput = document.getElementById('endpointInput');
    const methodSelect = document.getElementById('methodSelect');
    const credentialSelect = document.getElementById('credentialSelect');
    const jsonBodyTextArea = document.getElementById('jsonBodyTextArea');

    window.sendJSON = async function () {
        errorP.innerHTML = "";
        const body = methodSelect.value == "GET" ? null : jsonBodyTextArea.value;
        try
        {
            const res = await fetching.jsonRequest(endpointInput.value, methodSelect.value, body, credentialSelect.value);
            resultDiv.innerHTML = "";
            try{
                const json = await res.json()
                createTreeView(json, resultDiv);
            }catch(err){
                if(typeof(err) == SyntaxError)
                {
                    resultDiv.innerHTML = await res.text();
                }
                throw err;
            }
        }catch(err)
        {
            errorP.innerHTML = err.toString();
            return;
        }
    }

    function createTreeView(json, container) {
        function buildTree(obj, parent) {
            Object.keys(obj).forEach(key => {
                let value = obj[key];
                let div = document.createElement("div");
                
                div.innerHTML = `<strong>${key}:</strong> <p class="${getClassName(value)}">${value}</p>`;
                parent.appendChild(div);
                
                if (typeof value === "object" && value) {
                    let subContainer = document.createElement("div");
                    subContainer.style.marginLeft = "20px";
                    div.appendChild(subContainer);
                    buildTree(value, subContainer);
                }
            });
        }
        buildTree(json, container);
    }
    function getClassName(value)
    {
        if(typeof value === 'object')
        {
            if(value === null) { return 'null'}
            else { return 'undefined'}
        }else{
            return typeof value;
        }
    }
</script>
</html>